name: Deploy Docs Preview
run-name: 'Deploy Docs Preview for Repository ${{ github.event.client_payload.artifact_repo }} PR #${{ github.event.client_payload.pr_number }}'

on:
  repository_dispatch:
    types: [pr-preview]

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT_GITHUB_TOKEN }}

      - name: Setup Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create gh-pages if missing
        run: |
          git fetch origin gh-pages:gh-pages || true

          if git show-ref --verify --quiet refs/heads/gh-pages; then
            echo "âœ… gh-pages exists, checking out..."
            git checkout gh-pages
          else
            echo "ðŸ“ Creating gh-pages branch"
            git checkout --orphan gh-pages
            git rm -rf . || true
            echo "" > index.html
            git add index.html
            git commit -m "Initialize gh-pages branch"
            git push origin gh-pages
          fi

      - name: Download PR artifact
        uses: actions/download-artifact@v4
        with:
          name: pr-${{ github.event.client_payload.pr_number }}
          path: ./temp-preview
          repository: ${{ github.event.client_payload.artifact_repo }}
          run-id: ${{ github.event.client_payload.artifact_run_id }}
          github-token: ${{ secrets.PAT_GITHUB_TOKEN }}

      - name: Move PR preview to branch
        run: |
          REPO_NAME=$(basename "${{ github.event.client_payload.artifact_repo }}")
          TARGET_DIR="./$REPO_NAME/pr-${{ github.event.client_payload.pr_number }}"
          mkdir -p "$TARGET_DIR"
          cp -r ./temp-preview/* "$TARGET_DIR/"
          rm -rf ./temp-preview

      - name: Copy template index.html from main if missing
        run: |
          git fetch origin main:index-template
          git checkout index-template -- index.template.html
          if [ ! -f index.html ]; then
            cp index.template.html index.html
          fi

      - name: Update index.html with current PRs
        run: |
          TEMPLATE=index.template.html
          INDEX=index.html
          REPO_NAME=$(basename "${{ github.event.client_payload.artifact_repo }}")
          PR_NUM=${{ github.event.client_payload.pr_number }}

          if grep -q '<!-- PR_PLACEHOLDER -->' $INDEX; then
            PR_BLOCK=$(sed -n '/<!-- PR_PLACEHOLDER -->/,/<!-- END_PR_PLACEHOLDER -->/p' $INDEX)
            # Remove bloco antigo
            sed -i '/<!-- PR_PLACEHOLDER -->/,/<!-- END_PR_PLACEHOLDER -->/d' $INDEX
          else
            PR_BLOCK=""
          fi

          NEW_PR="<div class='card'><h3><a href='$REPO_NAME/pr-$PR_NUM/'>$REPO_NAME</a></h3><p>Pull Request #$PR_NUM</p></div>"

          echo "<!-- PR_PLACEHOLDER -->" > tmp_block.html
          echo "$PR_BLOCK" | grep -v '<!-- PR_PLACEHOLDER -->\|<!-- END_PR_PLACEHOLDER -->' >> tmp_block.html
          echo "$NEW_PR" >> tmp_block.html
          echo "<!-- END_PR_PLACEHOLDER -->" >> tmp_block.html

          sed -i "/<div class=\"grid\">/r tmp_block.html" $INDEX
          rm tmp_block.html

      - name: Commit updates to gh-pages
        run: |
          git add .
          git commit -m "Update previews for PR #${{ github.event.client_payload.pr_number }}" || echo "Nothing to commit"
          git push origin gh-pages

      - name: Upload artifact for Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./
          name: github-pages-pr-${{ github.event.client_payload.pr_number }}
          retention-days: 1

      - name: Deploy Pages Preview
        id: deployment
        uses: actions/deploy-pages@v4
        with:
          artifact_name: github-pages-pr-${{ github.event.client_payload.pr_number }}
          preview: true

      - name: Comment PR with preview link
        run: |
          REPO_NAME=$(basename "${{ github.event.client_payload.artifact_repo }}")
          PREVIEW_URL="https://${{ github.repository_ow
